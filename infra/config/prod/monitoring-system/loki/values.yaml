# Production Loki Configuration with Custom Labels Support
# Custom labels: app, component, container, filename, instance, namespace, job, node_name, pod, service_name
# Configured for SingleBinary deployment mode with enhanced performance and security

loki:
  # Use SingleBinary for production simplicity with better resource management
  deploymentMode: SingleBinary
  
  loki:
    # Production security settings
    auth_enabled: false  # Internal cluster access only
    
    # Enhanced limits configuration for custom labels in production
    limits_config:
      # Production-grade limits for high-volume logging
      max_streams_per_user: 50000        # Higher limit for production workloads
      max_entries_limit_per_query: 10000  # Larger query results
      max_label_names_per_series: 50      # Support extensive custom labels
      max_line_size: 512000               # Larger log lines for detailed logs
      
      # Rate limiting for production stability - Protects Loki during spikes
      ingestion_rate_mb: 32               # Higher ingestion rate
      ingestion_burst_size_mb: 64         # Larger burst capacity
      
      # Retention and performance
      retention_period: 30d               # 30-day retention for production
      query_timeout: 600s                 # Longer timeout for complex queries
      max_query_parallelism: 32           # Higher parallelism
      
      # Memory and performance limits
      max_cache_freshness_per_query: 1m   # Fresh cache for production
      split_queries_by_interval: 30m      # Optimize query splitting
    
    # Production compactor configuration
    compactor:
      retention_enabled: true
      retention_delete_delay: 2h
      delete_request_store: filesystem
      working_directory: /var/loki/compactor
    
    # Disable problematic cache configuration for stability
    query_range:
      align_queries_with_step: true
      cache_results: false
      max_retries: 5
      parallelise_shardable_queries: true
# Production SingleBinary deployment configuration
singleBinary:
  replicas: 1  # Single instance for production
  
  # Production-grade resource allocation
  resources:
    requests:
      cpu: "500m"      # Higher CPU for production workload
      memory: "2Gi"     # More memory for custom labels and caching
    limits:
      cpu: "1000m"     # Allow CPU bursts for query processing
      memory: "4Gi"     # Higher memory limit for production
  
  # Persistent storage for production data
  persistence:
    enabled: true      # Enable persistent storage
    size: "50Gi"       # Larger storage for production logs
    storageClass: ""   # Use default storage class
  
  # Production security context (more restrictive than dev)
  podSecurityContext:
    runAsNonRoot: true   # Run as non-root for security
    runAsUser: 10001     # Specific user ID
    fsGroup: 10001       # File system group
  
  containerSecurityContext:
    readOnlyRootFilesystem: true   # Read-only root filesystem
    runAsNonRoot: true             # Non-root container
    runAsUser: 10001               # Specific user ID
    allowPrivilegeEscalation: false # No privilege escalation
    capabilities:
      drop:
      - ALL                        # Drop all capabilities
  
  # Production node affinity and tolerations
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: node-type
            operator: In
            values: ["monitoring"]  # Prefer monitoring nodes
  
  # Disable microservices components
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0
  gateway:
    enabled: false
# Production monitoring and optional components
monitoring:
  serviceMonitor:
    enabled: true                    # Enable Prometheus monitoring
    labels:
      release: prometheus-stack-prod # Match Prometheus operator
  
  # Production alerting rules
  rules:
    enabled: true                    # Enable alerting rules
    groups:
    - name: loki-production
      rules:
      - alert: LokiHighIngestionRate
        expr: rate(loki_ingester_samples_received_total[5m]) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High log ingestion rate detected"

# Disable optional components for production stability
minio:
  enabled: false     # No object storage needed
lokiCanary:
  enabled: false     # No canary testing in production
test:
  enabled: false     # No test pods

# Enable caching for production performance (but disable problematic cache)
chunksCache:
  enabled: false     # Disable to avoid configuration issues
resultsCache:
  enabled: false     # Disable to avoid configuration issues