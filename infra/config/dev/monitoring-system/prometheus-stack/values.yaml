# Dev Environment Prometheus & Grafana Configuration
# Line-by-line explanation:

namespace: dev  # Deploy to dev namespace

# Grafana specific settings for DEV
grafana:
  # Domain configuration for dev environment
  grafana.ini:
    server:
      domain: "dev.grafana.local"  # Dev Grafana URL
      root_url: "http://dev.grafana.local:8000/"  # Full URL with port
  
  # Ingress configuration to make Grafana accessible
  ingress:
    enabled: true  # Enable ingress for external access
    ingressClassName: nginx  # Use nginx ingress controller
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "false"  # No HTTPS redirect in dev
      nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    hosts:
      - dev.grafana.local  # Hostname for dev Grafana
    paths:
      - path: /  # Root path
        pathType: Prefix  # Match all paths starting with /
  
  # Data sources - where Grafana gets data from
  additionalDataSources:
    - name: Prometheus  # Data source name
      type: prometheus  # Prometheus type
      url: http://prometheus-stack-dev-kube-prom-prometheus.dev.svc.cluster.local:9090  # Prometheus service URL
      access: proxy  # Access through Grafana proxy
      isDefault: true  # Make this the default data source

# Prometheus specific settings for DEV  
prometheus:
  prometheusSpec:
    # Service monitor selector - which services to monitor
    serviceMonitorSelector:
      matchLabels:
        release: prometheus-stack-dev  # Only monitor services with this label
    
    # Relaxed resources for dev
    resources:
      requests:
        cpu: "100m"  # Minimum CPU
        memory: "512Mi"  # Minimum memory
      limits:
        cpu: "500m"  # Maximum CPU
        memory: "1Gi"  # Maximum memory
    
    # Smaller storage for dev
    storageSpec:
      volumeClaimTemplate:
        spec:
          resources:
            requests:
              storage: 5Gi

# Fix node-exporter port conflict
prometheus-node-exporter:
  hostNetwork: false  # Don't use host network
  service:
    port: 9100
    targetPort: 9100
  # Remove host port binding
  extraArgs:
    - --web.listen-address=0.0.0.0:9100

# Service monitors for dev applications
app:
  serviceMonitors:
    - name: backend-dev-monitor
      namespace: dev
      selector:
        matchLabels:
          app.kubernetes.io/instance: backend-dev
          app.kubernetes.io/name: backend
      endpoints:
        - port: http
          path: /metrics
          interval: 15s
    - name: frontend-dev-monitor  
      namespace: dev
      selector:
        matchLabels:
          app.kubernetes.io/instance: frontend-dev
          app.kubernetes.io/name: frontend
      endpoints:
        - port: http
          path: /metrics
          interval: 15s